<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ SERVER_NAME }}</title>
      <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}
  <div class="container">
    <h1>Welcome to Plex!</h1>

    <p class="max-850">
      Plex Media Server (or just <a href="https://support.plex.tv/articles/200288286-what-is-plex/" target="_blank">Plex</a>) lets me share my collection of movies and shows with you, just like Netflix, but you don't have to pay. You can watch on your TV, computer, phone, or tablet!
    </p>

    {% set library_list = library_posters.keys()|list %}
    {% set mid_point = (library_list|length / 2)|round(0, 'ceil')|int %}
    {% set row1_libraries = library_list[:mid_point] %}
    {% set row2_libraries = library_list[mid_point:] %}

    <!-- Row 1 -->
    <div class="carousel-row">
      <div class="poster-carousel-container">
        <div class="poster-carousel animate" id="row0-carousel"></div>
      </div>
      
      <div class="row-selector">
        {% for lib_name in row1_libraries %}
          <button class="row-tab {% if loop.first %}active{% endif %}" data-row="0" data-library="{{ lib_name }}">{{ lib_name }}</button>
        {% endfor %}
      </div>
    </div>

    <!-- Row 2 (only if we have libraries for it) -->
    {% if row2_libraries %}
      <div class="carousel-row">
        <div class="poster-carousel-container">
          <div class="poster-carousel animate" id="row1-carousel"></div>
        </div>
        
        <div class="row-selector">
          {% for lib_name in row2_libraries %}
            <button class="row-tab {% if loop.first %}active{% endif %}" data-row="1" data-library="{{ lib_name }}">{{ lib_name }}</button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <p class="muted" style="margin-top: 1em; text-align: center; color: #aaa;">
      Random selection of posters from each library. Go <a href="/medialists" class="accent">here</a> for the full list.
    </p>

    <img src="{{ url_for('static', filename='homepage.webp') }}" alt="Homepage Example" class="toggle-grow" />

    <p class="muted">
      Click to enlarge (Zoom on mobile)
    </p>
  </div>
  <div class="container">
    <details {% if submitted %}open{% endif %}>
      <summary class="collapsible-heading">1. Get Access</summary>
      <div style="margin-left: 1em;">
        <p>To get started, enter your email below and select what you want access to. Let me know when you're done, and you'll recieve an email or invite link.</p>

        <p class="muted">
          Note: Please don't share the account you create with others. If you know someone who you think would enjoy having access, let me know. In most cases I'll be happy to add them with their own account.
        </p>
        <form method="POST" action="/onboarding" id="onboarding-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label for="email">Email:</label><br>
          <input type="email" name="email" placeholder="Enter email for Plex" required
                 class="max-300"
                 {% if submitted %}disabled{% endif %} />
          <div class="text-left max-800" style="margin: 1em 0;">
            <div class="library-table-container">
              <table class="library-table">
                <tbody>
                  {% for lib in libraries %}
                    <tr>
                      <td class="lib-checkbox">
                        <input type="checkbox" name="libraries" value="{{ lib.key }}" {% if submitted %}disabled{% endif %} />
                      </td>
                      <td class="lib-title">
                        {{ lib.title }}
                      </td>
                      <td class="lib-desc">
                        {% if library_notes[lib.key|string] and library_notes[lib.key|string]['description'] %}
                          <span class="muted">{{ library_notes[lib.key|string]['description'] }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <p>
              If you picked any audio category, check out Plex's audio app for phones and tablets, Plexamp. You can find a link in "Logging In" below.
            </p>
          </div>
          <button type="submit" {% if submitted %}disabled{% endif %}>Submit</button>
        </form>
        <div id="onboarding-success" style="display:none;">
          <p class="accent" style="font-weight: bold; margin-top: 1em;">
            Thanks! Your request has been submitted.
          </p>
        </div>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">2. Logging In</summary>
      <div style="margin-left: 1em;">
        <p>
          Once you get the invite, go ahead and make a Plex account, and download the app on your device. 
        </p>
        <p>
          <a href="https://www.plex.tv/media-server-downloads/?cat=plex+desktop&plat=windows#plex-app" target="_blank">Here</a> is a link to a list of compatible devices with download links.
        </p>
        <p>
         You can also access it via web browser on desktop at <a href="https://app.plex.tv/" target="_blank">app.plex.tv</a> to try it out, but I'd prefer if you use the standalone Windows or Mac app. 
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">3. First Time Setup</summary>
      <div style="margin-left: 1em;">    
        <p>
          While Plex is generally easy to use, there are some important settings to change the first time you use it.
        </p>

        <p>
          First is the removal of Live TV content provided by Plex. This content has ads and clutters the home page on some devices.
        </p>

        <p>
          To change this setting, use the web or desktop app versions of Plex.
        </p>

        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='newuser1.webp') }}" alt="New User Screenshot" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Go to "Online Media Sources"
          </figcaption>
        </figure>
        
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='onlinemedia.webp') }}" alt="Online Media Setting" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Disable Live TV, Movies & Shows, and Other Streaming Availability. The others can stay as-is.
          </figcaption>
        </figure>
        
       
        <p>
          You can poke around in the account settings and change things in the other tabs too.	
        </p>

        <p>
          Next is to increase streaming quality. Check out <a href="https://mediaclients.wiki/Plex" target="_blank">this</a> handy guide for getting the best quality stream.
    </p>

        <p>
          If you don't want to read all that, here's the general flow (must be done on every device):
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Open Plex settings</li>
          <li>Find Video or Quality settings</li>
          <li>Disable any Automatic adjustments</li>
          <li>Change streaming quality to Maximum</li>
          <li>Enable Direct Play/Direct Stream</li>
        </ul>

        <p>
          Note: If you're a nerd and want the best possible Plex experience on your TV, I reccomend one of these: 
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Nvidia Shield Pro (2019) – plays nearly everything flawlessly, best overall.</li>
          <li>Apple TV 4K (3rd Gen) – nearly as good, faster UI, only lacks full TRUEHD passthrough.</li>
          <li>FireTV Cube (3rd Gen) – smooth UI, but has DTS playback issues.</li>
        </ul>
        <p>
        Not required unless you notice problems on your current TV device or want the best playback quality.
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">4. Pinning/Favoriting Libraries</summary>
      <div style="margin-left: 1em;">
    
        <h3>Desktop</h3>
        <p>
          Once those settings have been changed, click the home button in the top left (on desktop) and you'll be taken to the page where all the magic happens.
        </p>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='sidemore.webp') }}" alt="Sidebar" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Click "More" at the bottom.
          </figcaption>
        </figure>
    
             <figure style="width: 100%; margin: 0 0 1em 0;">
              <img src="{{ url_for('static', filename='unpin.webp') }}" alt="Unpinning" class="toggle-grow" />
              <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
                Unpin Playlists, Live TV, Movies & Shows, and Rentals. Make sure my sections at the top are pinned.
              </figcaption>
            </figure>
            
    
        <h3>Mobile/Tablet</h3>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='mobilehome.webp') }}" alt="Mobile Home Screen" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Press and hold "Libraries", go to the all libraries menu, and favorite everything there.
          </figcaption>
        </figure>
        
    
        <p>
          And you're all set! Browse through my libraries, check out my movie collections (separate tab in Movies library), or put on a comfort show and go to sleep. If you ever want a show or movie that I don't have, see "Requests" below.
        </p>

        <img src="{{ url_for('static', filename='screens.webp') }}"
        alt="Screens"
        class="toggle-grow" />
    
      </div>
    </details>
  </div>
  {% if pulsarr_enabled or overseerr_enabled %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">5. Requests</summary>
      <div style="margin-left: 1em;">
        {% if pulsarr_enabled %}
        <h3>Plex Watchlist Requests</h3>
        <p>
          Through some technomancy, requesting movies and shows you want is pretty easy.
        </p>
        <p>
          We have to be "friends" on Plex (different than adding you to my server) for this feature to work so tell me to do that first before you request anything.
        </p>
        <p class="accent">
          Note: This feature does not work for new movies currently in theaters. Anything older or already on streaming services should be available.
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Go to the search bar or search menu</li>
          <li>Enable "More Ways to Watch" if not already enabled</li>
          <li>Search for the media you want</li>
          <li>Click the "Add to watchlist" icon</li>
        </ul>
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='watchlist.webp') }}" alt="Watchlist" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Desktop Example
          </figcaption>
        </figure>
        <p>
          Movies should show up in less than 30 minutes. Shows can take longer. The first season will show up to start, and others as you watch. If it's a show that's airing now and you want a more recent season, let me know.
        </p>
        <p class="accent">
          Be nice to my hard drives, don't request too much!
        </p>
        <h3>Notifications</h3>
        <p>
          If I added you as a friend, you can receive notifications on phones and tablets when your Watchlisted media is available. For shows, this only applies when it is added for the first time.{% if tautulli_enabled %} For per-episode notifications about currently airing shows, ask me about my Discord.{% endif %}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Make sure notifications are enabled for Plex on your phone (Settings app)</li>
          <li>Go to settings in Plex > Notifications</li>
          <li>Turn off anything you'd like in Plex News, Friends, Discover, Live TV</li>
          <li>Scroll down to Personal Media > New Content Added to Library</li>
          <li>Set the toggles to how they look below (all off except for top one)</li>
        </ul>
        <img src="{{ url_for('static', filename='notifs.webp') }}"
             alt="Notification Settings"
             class="toggle-grow" />
        {% endif %}
        {% if overseerr_enabled %}
        <h3>Overseerr Requests</h3>
        <p>
          You can request movies and shows directly using Overseerr. Click the link below to open the request page:
        </p>
        <p>
          <a href="{{ overseerr_url }}" target="_blank" class="accent">Open Overseerr</a>
        </p>
        <p class="muted">
          Requests made here will be sent to the admin for approval and processing.
        </p>
        {% endif %}
      </div>
    </details>
  </div>
  {% endif %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}6{% else %}5{% endif %}. Issues</summary>
      <div style="margin-left: 1em;">
    
        <p>
          If you have issues playing a specific piece of media, or it has bad subs, you can report it through Plex or just tell me.
        </p>
    
        <img src="{{ url_for('static', filename='issue.webp') }}"
             alt="Report Issue"
             class="toggle-grow" />
    
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}7{% else %}6{% endif %}. The End</summary>
      <div style="margin-left: 1em;">
        {% include "onboarding_section7.html" %}
      </div>
    </details>
  </div>

  <script>
    function handleSubmit(event) {
      // Allow form to submit normally and delay disabling
      setTimeout(() => {
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = true);
      }, 50); // enough time for submit to start

      return true; // let form proceed
    }
  </script>

  <script>
    // AJAX onboarding form submission for Plex
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('onboarding-form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const data = new URLSearchParams();
          for (const pair of formData) {
            data.append(pair[0], pair[1]);
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          Array.from(form.elements).forEach(el => el.disabled = true);
          try {
            const response = await fetch('/onboarding', {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: data
            });
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                document.getElementById('onboarding-success').style.display = '';
                form.style.display = 'none';
              } else {
                alert(result.error || 'Submission failed.');
                Array.from(form.elements).forEach(el => el.disabled = false);
                if (submitBtn) submitBtn.disabled = false;
              }
            } else {
              alert('Submission failed.');
              Array.from(form.elements).forEach(el => el.disabled = false);
              if (submitBtn) submitBtn.disabled = false;
            }
          } catch (err) {
            alert('Submission failed.');
            Array.from(form.elements).forEach(el => el.disabled = false);
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Row-based tab switching functionality
      const rowTabs = document.querySelectorAll('.row-tab');
      
      // Library data from template
      const libraryPosters = JSON.parse('{{ library_posters|tojson|safe }}');
      const posterImdbIds = JSON.parse('{{ poster_imdb_ids|tojson|safe if poster_imdb_ids else "{}" }}');
      
      // Track current library for each row
      const currentLibraries = {
        0: null,
        1: null
      };
      
      // Load initial carousels
      const firstRowTab = document.querySelector('.row-tab[data-row="0"]');
      const secondRowTab = document.querySelector('.row-tab[data-row="1"]');
      
      console.log('Available library data:', libraryPosters);
      console.log('First row tab:', firstRowTab);
      console.log('Second row tab:', secondRowTab);
      
      if (firstRowTab) {
        const libraryName = firstRowTab.getAttribute('data-library');
        console.log('Loading first carousel with library:', libraryName);
        currentLibraries[0] = libraryName;
        loadCarousel('row0-carousel', libraryName);
      }
      if (secondRowTab) {
        const libraryName = secondRowTab.getAttribute('data-library');
        console.log('Loading second carousel with library:', libraryName);
        currentLibraries[1] = libraryName;
        loadCarousel('row1-carousel', libraryName);
      }
      
      function loadCarousel(carouselId, library) {
        const carousel = document.getElementById(carouselId);
        if (!carousel) {
          console.log(`Carousel ${carouselId} not found`);
          return;
        }
        
        console.log(`Loading carousel ${carouselId} with library ${library}`);
        
        // Stop any existing animation
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Clear existing content
        carousel.innerHTML = '';
        carousel.style.transform = 'translateX(0px)';
        
        // Show loading state
        carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">Loading posters...</div>';
        
        // Function to fetch random posters from server
        async function fetchRandomPosters(count = 10) {
          try {
            console.log(`Fetching ${count} random posters for library: "${library}"`);
            
            const requestData = {
              library: library,
              count: count
            };
            
            console.log('Sending request data:', requestData);
            
            const response = await fetch('/ajax/get-random-posters', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: JSON.stringify(requestData)
            });
            
            console.log(`Response status: ${response.status}`);
            console.log(`Response headers:`, Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
              const data = await response.json();
              console.log(`Received ${data.posters.length} posters from server`);
              return data;
            } else {
              const errorText = await response.text();
              console.error('Failed to fetch random posters:', response.status, errorText);
              
              // Try to parse as JSON for better error info
              try {
                const errorData = JSON.parse(errorText);
                console.error('Error details:', errorData);
              } catch (e) {
                console.error('Raw error response:', errorText);
              }
              
              return { posters: [], imdb_ids: [] };
            }
          } catch (error) {
            console.error('Error fetching random posters:', error);
            return { posters: [], imdb_ids: [] };
          }
        }
        
        // Function to add posters to carousel
        function addPostersToCarousel(posters, imdbIds) {
          // Clear loading state
          carousel.innerHTML = '';
          
          if (posters.length === 0) {
            carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">No posters available for this library</div>';
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const imgElement = imdbId ? 
              `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>` :
              `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          console.log(`Added ${posters.length} new posters for ${library}`);
        }
        
        // Function to append posters to the end of carousel (out of view)
        function appendPostersToCarousel(posters, imdbIds) {
          if (posters.length === 0) {
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const imgElement = imdbId ? 
              `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>` :
              `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          // Update carousel width after adding new posters
          updateWidth();
          console.log(`Appended ${posters.length} new posters to carousel for ${library}`);
        }
        
        // Function to update carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
        }
        
        // Function to ensure minimum posters in carousel
        function ensureMinimumPosters() {
          const currentPosters = carousel.children.length;
          if (currentPosters < 5) {
            console.log(`Only ${currentPosters} posters left, adding more...`);
            // Try to load more posters
            fetchRandomPosters(5).then(data => {
              if (data.posters.length > 0) {
                appendPostersToCarousel(data.posters, data.imdb_ids);
              } else {
                // If AJAX fails, try fallback data
                if (libraryPosters[library] && libraryPosters[library].length > 0) {
                  const posters = libraryPosters[library];
                  const imdbIds = posterImdbIds[library] || [];
                  const nextBatch = posters.slice(0, 5);
                  const nextImdbIds = imdbIds.slice(0, 5);
                  if (nextBatch.length > 0) {
                    appendPostersToCarousel(nextBatch, nextImdbIds);
                  }
                }
              }
            }).catch(error => {
              console.error('Error ensuring minimum posters:', error);
            });
          }
        }
        
        // Load initial posters
        fetchRandomPosters(15).then(data => {
          if (data.posters.length > 0) {
            addPostersToCarousel(data.posters, data.imdb_ids);
            
            // Start animation immediately
            setupInfiniteCarousel(carousel, async () => {
              // Load more random posters when needed
              const newData = await fetchRandomPosters(5);
              if (newData.posters.length > 0) {
                appendPostersToCarousel(newData.posters, newData.imdb_ids);
              }
            });
          } else {
            // Fallback to original library_posters data if AJAX fails
            console.log('AJAX failed, using fallback data for', library);
            if (libraryPosters[library] && libraryPosters[library].length > 0) {
              const posters = libraryPosters[library];
              const imdbIds = posterImdbIds[library] || [];
              
              // Use first 15 posters from the original data
              const initialPosters = posters.slice(0, 15);
              const initialImdbIds = imdbIds.slice(0, 15);
              
              addPostersToCarousel(initialPosters, initialImdbIds);
              
              // Start animation with fallback loading
              setupInfiniteCarousel(carousel, () => {
                // Load more from original data
                const currentCount = carousel.children.length;
                const nextBatch = posters.slice(currentCount, currentCount + 5);
                const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
                if (nextBatch.length > 0) {
                  appendPostersToCarousel(nextBatch, nextImdbIds);
                }
              });
            } else {
              // No posters available at all
              addPostersToCarousel([], []);
            }
          }
        }).catch(error => {
          console.error('Error in initial poster loading:', error);
          // Fallback to original library_posters data
          if (libraryPosters[library] && libraryPosters[library].length > 0) {
            const posters = libraryPosters[library];
            const imdbIds = posterImdbIds[library] || [];
            
            const initialPosters = posters.slice(0, 15);
            const initialImdbIds = imdbIds.slice(0, 15);
            
            addPostersToCarousel(initialPosters, initialImdbIds);
            
            setupInfiniteCarousel(carousel, () => {
              const currentCount = carousel.children.length;
              const nextBatch = posters.slice(currentCount, currentCount + 5);
              const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
              if (nextBatch.length > 0) {
                appendPostersToCarousel(nextBatch, nextImdbIds);
              }
            });
          } else {
            addPostersToCarousel([], []);
          }
        });
      }
      
      rowTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const targetRow = this.getAttribute('data-row');
          const targetLibrary = this.getAttribute('data-library');
          
          // Only reload if library actually changed
          if (currentLibraries[targetRow] !== targetLibrary) {
            console.log(`Switching row ${targetRow} from ${currentLibraries[targetRow]} to ${targetLibrary}`);
            
            // Update active tab for this row
            const rowTabsForThisRow = document.querySelectorAll(`.row-tab[data-row="${targetRow}"]`);
            rowTabsForThisRow.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update current library tracking
            currentLibraries[targetRow] = targetLibrary;
            
            // Load new carousel data
            const carouselId = `row${targetRow}-carousel`;
            loadCarousel(carouselId, targetLibrary);
          }
        });
      });

      // Only enable enlarge on screens wider than 1081px (adjust as needed)
      if (window.innerWidth >= 1081) {
        document.querySelectorAll(".toggle-grow").forEach(function (img) {
          img.addEventListener("click", function () {
            const isGrown = img.classList.toggle("grown");

            if (!isGrown) {
              img.style.left = "0px";
              img.style.top = "0px";
              img.style.position = "relative";
              img.style.zIndex = "";
            } else {
              img.style.position = "relative";
              img.style.zIndex = 10;
            }
          });
        });
      }

      // --- Improved Infinite Carousel Logic ---
      function setupInfiniteCarousel(carousel, onLoadMore = null) {
        const container = carousel.parentElement;
        let scrollSpeed = 0.6; // px per frame - 25% slower (was 0.8)
        let isPaused = false;
        let offset = 0;
        let lastLoadCheck = 0;
        let isLoading = false; // Prevent multiple simultaneous loads

        // Clear any existing animation and event listeners
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Remove existing event listeners to prevent duplicates
        if (carousel._mouseEnterHandler) {
          container.removeEventListener('mouseenter', carousel._mouseEnterHandler);
        }
        if (carousel._mouseLeaveHandler) {
          container.removeEventListener('mouseleave', carousel._mouseLeaveHandler);
        }

        // Reset transform
        carousel.style.transform = 'translateX(0px)';

        // Set carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            console.log('No children in carousel for width calculation');
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              console.log(`Image ${index} has zero width, using naturalWidth`);
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
          console.log(`Carousel width set to: ${totalWidth}px`);
        }
        
        // Update width immediately and after a short delay
        updateWidth();
        setTimeout(updateWidth, 100);

        // Animation loop using transform
        function animate() {
          try {
            // Don't animate if there are no images or if we have a loading/error message
            if (carousel.children.length === 0 || carousel.querySelector('div')) {
              carousel.rafId = requestAnimationFrame(animate);
              return;
            }
            
            if (!isPaused) {
              offset -= scrollSpeed;
              carousel.style.transform = `translateX(${offset}px)`;
              
              // Remove images that have scrolled completely off screen
              const firstImg = carousel.children[0];
              if (firstImg && (firstImg.tagName === 'IMG' || firstImg.tagName === 'A')) {
                const firstImgWidth = firstImg.offsetWidth + parseInt(getComputedStyle(carousel).gap || 0);
                if (Math.abs(offset) >= firstImgWidth) {
                  firstImg.remove();
                  offset += firstImgWidth;
                  carousel.style.transform = `translateX(${offset}px)`;
                  
                  // Update width after removing image
                  updateWidth();
                }
              }
              
              // Check if we need to load more posters (every 3 seconds)
              const now = Date.now();
              if (onLoadMore && now - lastLoadCheck > 3000 && !isLoading) {
                lastLoadCheck = now;
                const remainingImages = carousel.children.length;
                if (remainingImages <= 15) { // Load earlier to prevent gaps
                  console.log(`Only ${remainingImages} images left, loading more...`);
                  isLoading = true;
                  try {
                    onLoadMore().then(() => {
                      isLoading = false;
                    }).catch(error => {
                      console.error('Error loading more posters:', error);
                      isLoading = false;
                      // Use safety mechanism to ensure minimum posters
                      ensureMinimumPosters();
                    });
                  } catch (error) {
                    console.error('Error in onLoadMore:', error);
                    isLoading = false;
                    ensureMinimumPosters();
                  }
                }
              }
            }
            carousel.rafId = requestAnimationFrame(animate);
          } catch (error) {
            console.error('Animation error:', error);
            // Stop animation on error
            if (carousel.rafId) {
              cancelAnimationFrame(carousel.rafId);
              carousel.rafId = null;
            }
          }
        }
        
        // Start animation immediately
        console.log(`Starting animation for carousel ${carousel.id}`);
        animate();

        // Pause on hover - store handlers to prevent duplicates
        carousel._mouseEnterHandler = () => { isPaused = true; };
        carousel._mouseLeaveHandler = () => { isPaused = false; };
        container.addEventListener('mouseenter', carousel._mouseEnterHandler);
        container.addEventListener('mouseleave', carousel._mouseLeaveHandler);
        
        // Periodic safety check to ensure carousel doesn't become empty
        setInterval(() => {
          if (carousel.children.length < 5) {
            console.log('Carousel running low on posters, adding more...');
            ensureMinimumPosters();
          }
        }, 5000); // Check every 5 seconds
      }
    });
  </script>

</body>
</html>
