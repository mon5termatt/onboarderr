<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ SERVER_NAME }}</title>
      <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}" />
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
    {% include "_bottom_nav.html" %}
  
  <!-- Fixed bottom-left service icons -->
  {% if services %}
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1000; background: rgba(0, 0, 0, 0.9); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); min-width: 200px;">
      <div style="margin-bottom: 8px; color: #aaa; font-size: 0.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">Quick Access</div>
      <div style="display: flex; gap: 0.8em; align-items: center; flex-wrap: wrap;">
        {% for service in services %}
          <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" style="display: flex; align-items: center; margin-bottom: 4px;">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 28px; height: 28px; border-radius: 6px; filter: brightness(0.9); transition: filter 0.2s ease;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(0.9)'">
            </a>
            <div style="color: #ccc; font-size: 0.7em; font-weight: 500; max-width: 60px; line-height: 1.2;">
              {% if service.name == "Plex" %}
                Media
              {% elif service.name == "Audiobookshelf" %}
                Books
              {% elif service.name == "Tautulli" %}
                Stats
              {% elif service.name == "Overseerr" %}
                Request
              {% else %}
                {{ service.name }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
      <h1 style="margin: 0;">Welcome to Plex!</h1>
      {% if services %}
        <div style="display: flex; gap: 0.5em; align-items: center;">
          {% for service in services %}
            <a href="{{ service.url }}" target="_blank" title="{{ service.name }}" style="display: flex; align-items: center;">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 24px; height: 24px; border-radius: 4px;">
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <p class="max-850">
      Plex Media Server (or just <a href="https://support.plex.tv/articles/200288286-what-is-plex/" target="_blank">Plex</a>) lets me share my collection of movies and shows with you, just like Netflix, but you don't have to pay. You can watch on your TV, computer, phone, or tablet!
    </p>

    {% set library_list = library_posters.keys()|list %}

    <!-- Single Carousel with Library Selector -->
    <div class="carousel-row">
      <div class="poster-carousel-container">
        <div class="poster-carousel animate" id="main-carousel"></div>
      </div>
      
      <div class="library-selector">
        <button class="library-tab {% if default_library == 'random-all' %}active{% endif %}" data-library="random-all">üé≤ Random All</button>
        {% for lib_name in library_list %}
          <button class="library-tab {% if default_library == lib_name %}active{% endif %}" data-library="{{ lib_name }}">{{ lib_name }}</button>
        {% endfor %}
      </div>
    </div>

    <p class="muted" style="margin-top: 1em; text-align: center; color: #aaa;">
      Random selection of posters from each library. Go <a href="/medialists" class="accent">here</a> for the full list.
    </p>

    <img src="{{ url_for('static', filename='homepage.webp') }}" alt="Homepage Example" class="toggle-grow" />

    <p class="muted">
      Click to enlarge (Zoom on mobile)
    </p>
  </div>
  <div class="container">
    <details {% if submitted %}open{% endif %}>
      <summary class="collapsible-heading">1. Get Access</summary>
      <div style="margin-left: 1em;">
        <p>To get started, enter your email below and select what you want access to. Let me know when you're done, and you'll recieve an email or invite link.</p>

        <p class="muted">
          Note: Please don't share the account you create with others. If you know someone who you think would enjoy having access, let me know. In most cases I'll be happy to add them with their own account.
        </p>
        <form method="POST" action="/onboarding" id="onboarding-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label for="email">Email:</label><br>
          <input type="email" name="email" placeholder="Enter email for Plex" required
                 class="max-300"
                 {% if submitted %}disabled{% endif %} />
          <div class="text-left max-800" style="margin: 1em 0;">
            <div class="library-table-container">
              <table class="library-table">
                <tbody>
                  {% for lib in libraries %}
                    <tr>
                      <td class="lib-checkbox">
                        <input type="checkbox" name="libraries" value="{{ lib.key }}" {% if submitted %}disabled{% endif %} />
                      </td>
                      <td class="lib-title">
                        {{ lib.title }}
                      </td>
                      <td class="lib-desc">
                        {% if library_notes[lib.key|string] and library_notes[lib.key|string]['description'] %}
                          <span class="muted">{{ library_notes[lib.key|string]['description'] }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if has_music_library %}
            <p>
              If you picked any audio category, check out Plex's audio app for phones and tablets, Plexamp. You can find a link in "Logging In" below.
            </p>
            {% endif %}
          </div>
          
          <!-- Explicit content checkbox temporarily hidden
          <div style="margin: 1em 0;">
            <label class="onboard-checkbox-label">
              <input type="checkbox" name="explicit_content" value="yes" {% if submitted %}disabled{% endif %} />
              <span>I would like access to explicit content (R-rated movies, mature shows, etc.)</span>
            </label>
            <div style="margin-left: 1.5em; color: #888; font-size: 0.9em;">
              This includes movies and shows with mature themes, violence, or adult content.
            </div>
          </div>
          -->
          
          <button type="submit" {% if submitted %}disabled{% endif %}>Submit</button>
        </form>
        
        <div style="margin: 1.5em 0; padding: 1em; background: #2a2a2a; border-radius: 0.5em; border-left: 4px solid #f6b900;">
          <p style="margin: 0; color: #f6b900; font-weight: bold;">‚ö†Ô∏è Content Disclaimer</p>
          <p style="margin: 0.5em 0 0 0; color: #aaa; font-size: 0.95em;">
            Some content in this media library may not be suitable for all ages. The server owner is not responsible for the content available through this service. Users are responsible for their own viewing choices and should exercise appropriate discretion.
          </p>
        </div>
        
        <div id="onboarding-success" style="display:none;">
          <p class="accent" style="font-weight: bold; margin-top: 1em;">
            Thanks! Your request has been submitted.
          </p>
        </div>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">2. Logging In</summary>
      <div style="margin-left: 1em;">
        <p>
          Once you get the invite, go ahead and make a Plex account, and download the app on your device. 
        </p>
        <p>
          <a href="https://www.plex.tv/media-server-downloads/?cat=plex+desktop&plat=windows#plex-app" target="_blank">Here</a> is a link to a list of compatible devices with download links.
        </p>
        <p>
         You can also access it via web browser on desktop at <a href="https://app.plex.tv/" target="_blank">app.plex.tv</a> to try it out, but I'd prefer if you use the standalone Windows or Mac app. 
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">3. First Time Setup</summary>
      <div style="margin-left: 1em;">    
        <p>
          While Plex is generally easy to use, there are some important settings to change the first time you use it.
        </p>

        <p>
          First is the removal of Live TV content provided by Plex. This content has ads and clutters the home page on some devices.
        </p>

        <p>
          To change this setting, use the web or desktop app versions of Plex.
        </p>

        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='newuser1.webp') }}" alt="New User Screenshot" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Go to "Online Media Sources"
          </figcaption>
        </figure>
        
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='onlinemedia.webp') }}" alt="Online Media Setting" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Disable Live TV, Movies & Shows, and Other Streaming Availability. The others can stay as-is.
          </figcaption>
        </figure>
        
       
        <p>
          You can poke around in the account settings and change things in the other tabs too.	
        </p>

        <p>
          Next is to increase streaming quality. Check out <a href="https://mediaclients.wiki/Plex" target="_blank">this</a> handy guide for getting the best quality stream.
    </p>

        <p>
          If you don't want to read all that, here's the general flow (must be done on every device):
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Open Plex settings</li>
          <li>Find Video or Quality settings</li>
          <li>Disable any Automatic adjustments</li>
          <li>Change streaming quality to Maximum</li>
          <li>Enable Direct Play/Direct Stream</li>
        </ul>

        <p>
          Note: If you're a nerd and want the best possible Plex experience on your TV, I reccomend one of these: 
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Nvidia Shield Pro (2019) ‚Äì plays nearly everything flawlessly, best overall.</li>
          <li>Apple TV 4K (3rd Gen) ‚Äì nearly as good, faster UI, only lacks full TRUEHD passthrough.</li>
          <li>FireTV Cube (3rd Gen) ‚Äì smooth UI, but has DTS playback issues.</li>
        </ul>
        <p>
        Not required unless you notice problems on your current TV device or want the best playback quality.
        </p>
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">4. Pinning/Favoriting Libraries</summary>
      <div style="margin-left: 1em;">
    
        <h3>Desktop</h3>
        <p>
          Once those settings have been changed, click the home button in the top left (on desktop) and you'll be taken to the page where all the magic happens.
        </p>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='sidemore.webp') }}" alt="Sidebar" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Click "More" at the bottom.
          </figcaption>
        </figure>
    
             <figure style="width: 100%; margin: 0 0 1em 0;">
              <img src="{{ url_for('static', filename='unpin.webp') }}" alt="Unpinning" class="toggle-grow" />
              <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
                Unpin Playlists, Live TV, Movies & Shows, and Rentals. Make sure my sections at the top are pinned.
              </figcaption>
            </figure>
            
    
        <h3>Mobile/Tablet</h3>
    
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='mobilehome.webp') }}" alt="Mobile Home Screen" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Press and hold "Libraries", go to the all libraries menu, and favorite everything there.
          </figcaption>
        </figure>
        
    
        <p>
          And you're all set! Browse through my libraries, check out my movie collections (separate tab in Movies library), or put on a comfort show and go to sleep. If you ever want a show or movie that I don't have, see "Requests" below.
        </p>

        <img src="{{ url_for('static', filename='screens.webp') }}"
        alt="Screens"
        class="toggle-grow" />
    
      </div>
    </details>
  </div>
  {% if pulsarr_enabled or overseerr_enabled %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">5. Requests</summary>
      <div style="margin-left: 1em;">
        {% if pulsarr_enabled %}
        <h3>Plex Watchlist Requests</h3>
        <p>
          Through some technomancy, requesting movies and shows you want is pretty easy.
        </p>
        <p>
          We have to be "friends" on Plex (different than adding you to my server) for this feature to work so tell me to do that first before you request anything.
        </p>
        <p class="accent">
          Note: This feature does not work for new movies currently in theaters. Anything older or already on streaming services should be available.
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Go to the search bar or search menu</li>
          <li>Enable "More Ways to Watch" if not already enabled</li>
          <li>Search for the media you want</li>
          <li>Click the "Add to watchlist" icon</li>
        </ul>
        <figure style="width: 100%; margin: 0 0 1em 0;">
          <img src="{{ url_for('static', filename='watchlist.webp') }}" alt="Watchlist" class="toggle-grow" />
          <figcaption class="caption" style="margin-top: 0.25em; margin-bottom: 1em; text-align: center;">
            Desktop Example
          </figcaption>
        </figure>
        <p>
          Movies should show up in less than 30 minutes. Shows can take longer. The first season will show up to start, and others as you watch. If it's a show that's airing now and you want a more recent season, let me know.
        </p>
        <p class="accent">
          Be nice to my hard drives, don't request too much!
        </p>
        <h3>Notifications</h3>
        <p>
          If I added you as a friend, you can receive notifications on phones and tablets when your Watchlisted media is available. For shows, this only applies when it is added for the first time.{% if tautulli_enabled %} For per-episode notifications about currently airing shows, ask me about my Discord.{% endif %}
        </p>
        <ul class="text-left max-800" style="margin: 1em 0;">
          <li>Make sure notifications are enabled for Plex on your phone (Settings app)</li>
          <li>Go to settings in Plex > Notifications</li>
          <li>Turn off anything you'd like in Plex News, Friends, Discover, Live TV</li>
          <li>Scroll down to Personal Media > New Content Added to Library</li>
          <li>Set the toggles to how they look below (all off except for top one)</li>
        </ul>
        <img src="{{ url_for('static', filename='notifs.webp') }}"
             alt="Notification Settings"
             class="toggle-grow" />
        {% endif %}
        {% if overseerr_enabled %}
        <h3>Overseerr Requests</h3>
        <p>
          You can request movies and shows directly using Overseerr. Click the link below to open the request page:
        </p>
        <p>
          <a href="{{ overseerr_url }}" target="_blank" class="accent">Open Overseerr</a>
        </p>
        <p class="muted">
          Requests made here will be sent to the admin for approval and processing.
        </p>
        {% endif %}
      </div>
    </details>
  </div>
  {% endif %}
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}6{% else %}5{% endif %}. Issues</summary>
      <div style="margin-left: 1em;">
    
        <p>
          If you have issues playing a specific piece of media, or it has bad subs, you can report it through Plex or just tell me.
        </p>
    
        <img src="{{ url_for('static', filename='issue.webp') }}"
             alt="Report Issue"
             class="toggle-grow" />
    
      </div>
    </details>
  </div>
  <div class="container">
    <details>
      <summary class="collapsible-heading">{% if pulsarr_enabled or overseerr_enabled %}7{% else %}6{% endif %}. The End</summary>
      <div style="margin-left: 1em;">
        {% include "onboarding_section7.html" %}
      </div>
    </details>
  </div>

  <script>
    function handleSubmit(event) {
      // Allow form to submit normally and delay disabling
      setTimeout(() => {
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = true);
      }, 50); // enough time for submit to start

      return true; // let form proceed
    }
  </script>

  <script>
    // AJAX onboarding form submission for Plex
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('onboarding-form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const data = new URLSearchParams();
          for (const pair of formData) {
            data.append(pair[0], pair[1]);
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          Array.from(form.elements).forEach(el => el.disabled = true);
          try {
            const response = await fetch('/onboarding', {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: data
            });
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                document.getElementById('onboarding-success').style.display = '';
                form.style.display = 'none';
              } else {
                alert(result.error || 'Submission failed.');
                Array.from(form.elements).forEach(el => el.disabled = false);
                if (submitBtn) submitBtn.disabled = false;
              }
            } else {
              alert('Submission failed.');
              Array.from(form.elements).forEach(el => el.disabled = false);
              if (submitBtn) submitBtn.disabled = false;
            }
          } catch (err) {
            alert('Submission failed.');
            Array.from(form.elements).forEach(el => el.disabled = false);
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Row-based tab switching functionality
      const rowTabs = document.querySelectorAll('.row-tab');
      
      // Library data from template
      const libraryPosters = JSON.parse('{{ library_posters|tojson|safe }}');
      const posterImdbIds = JSON.parse('{{ poster_imdb_ids|tojson|safe if poster_imdb_ids else "{}" }}');
      
      // Track current library
      let currentLibrary = null;
      
      // Load initial carousel with default library
      const defaultLibrary = '{{ default_library }}';
      const defaultTab = document.querySelector(`.library-tab[data-library="${defaultLibrary}"]`);
      
      console.log('Available library data:', libraryPosters);
      console.log('Default library:', defaultLibrary);
      console.log('Default tab:', defaultTab);
      
      if (defaultTab) {
        console.log(`Loading carousel with ${defaultLibrary}`);
        currentLibrary = defaultLibrary;
        loadCarousel('main-carousel', defaultLibrary);
      }
      
      function loadCarousel(carouselId, library) {
        const carousel = document.getElementById(carouselId);
        if (!carousel) {
          console.log(`Carousel ${carouselId} not found`);
          return;
        }
        
        console.log(`Loading carousel ${carouselId} with library ${library}`);
        
        // Stop any existing animation
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Clear existing content
        carousel.innerHTML = '';
        carousel.style.transform = 'translateX(0px)';
        
        // Show loading state
        carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">Loading posters...</div>';
        
        // Function to fetch random posters from server
        async function fetchRandomPosters(count = 10) {
          try {
            console.log(`Fetching ${count} random posters for library: "${library}"`);
            
            let endpoint = '/ajax/get-random-posters';
            let requestData = {
              count: count
            };
            
            if (library === 'random-all') {
              endpoint = '/ajax/get-random-posters-all';
              requestData.include_music = false;  // Exclude music by default for "Random All"
              console.log('Using random-all endpoint (excluding music)');
            } else {
              requestData.library = library;
            }
            
            console.log('Sending request data:', requestData);
            
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: JSON.stringify(requestData)
            });
            
            console.log(`Response status: ${response.status}`);
            console.log(`Response headers:`, Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
              const data = await response.json();
              console.log(`Received ${data.posters.length} posters from server`);
              return data;
            } else {
              const errorText = await response.text();
              console.error('Failed to fetch random posters:', response.status, errorText);
              
              // Try to parse as JSON for better error info
              try {
                const errorData = JSON.parse(errorText);
                console.error('Error details:', errorData);
              } catch (e) {
                console.error('Raw error response:', errorText);
              }
              
              return { posters: [], imdb_ids: [] };
            }
          } catch (error) {
            console.error('Error fetching random posters:', error);
            return { posters: [], imdb_ids: [] };
          }
        }
        
        // Function to add posters to carousel
        function addPostersToCarousel(posters, imdbIds, lastfmUrls) {
          // Clear loading state
          carousel.innerHTML = '';
          
          if (posters.length === 0) {
            carousel.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #888;">No posters available for this library</div>';
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const lastfmUrl = lastfmUrls ? lastfmUrls[index] : null;
            
            let imgElement;
            if (lastfmUrl) {
              // If it's a music artist, link to Last.fm
              imgElement = `<a href="${lastfmUrl}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else if (imdbId) {
              // If it has IMDB ID, link to IMDB
              imgElement = `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else {
              // No link
              imgElement = `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            }
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          console.log(`Added ${posters.length} new posters for ${library}`);
        }
        
        // Function to append posters to the end of carousel (out of view)
        function appendPostersToCarousel(posters, imdbIds, lastfmUrls) {
          if (posters.length === 0) {
            return;
          }
          
          posters.forEach((poster, index) => {
            const imdbId = imdbIds[index];
            const lastfmUrl = lastfmUrls ? lastfmUrls[index] : null;
            
            let imgElement;
            if (lastfmUrl) {
              // If it's a music artist, link to Last.fm
              imgElement = `<a href="${lastfmUrl}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else if (imdbId) {
              // If it has IMDB ID, link to IMDB
              imgElement = `<a href="https://www.imdb.com/title/${imdbId}" target="_blank"><img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy"></a>`;
            } else {
              // No link
              imgElement = `<img src="${poster}" class="carousel-img" alt="${library} poster" loading="lazy">`;
            }
            
            carousel.insertAdjacentHTML('beforeend', imgElement);
          });
          
          // Update carousel width after adding new posters
          updateWidth();
          console.log(`Appended ${posters.length} new posters to carousel for ${library}`);
        }
        
        // Function to update carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
        }
        
        // Function to ensure minimum posters in carousel
        function ensureMinimumPosters() {
          const currentPosters = carousel.children.length;
          if (currentPosters < 5) {
            console.log(`Only ${currentPosters} posters left, adding more...`);
            // Try to load more posters
            fetchRandomPosters(5).then(data => {
              if (data.posters.length > 0) {
                appendPostersToCarousel(data.posters, data.imdb_ids);
              } else {
                // If AJAX fails, try fallback data
                if (library === 'random-all') {
                  // For random-all, combine all available posters
                  const allPosters = [];
                  const allImdbIds = [];
                  Object.keys(libraryPosters).forEach(libName => {
                    if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                      allPosters.push(...libraryPosters[libName]);
                      const imdbIds = posterImdbIds[libName] || [];
                      allImdbIds.push(...imdbIds);
                    }
                  });
                  if (allPosters.length > 0) {
                    // Get random selection from all posters
                    const indices = [];
                    for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                      indices.push(Math.floor(Math.random() * allPosters.length));
                    }
                    const nextBatch = indices.map(i => allPosters[i]);
                    const nextImdbIds = indices.map(i => allImdbIds[i] || null);
                    appendPostersToCarousel(nextBatch, nextImdbIds);
                  }
                } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
                  const posters = libraryPosters[library];
                  const imdbIds = posterImdbIds[library] || [];
                  const nextBatch = posters.slice(0, 5);
                  const nextImdbIds = imdbIds.slice(0, 5);
                  if (nextBatch.length > 0) {
                    appendPostersToCarousel(nextBatch, nextImdbIds);
                  }
                }
              }
            }).catch(error => {
              console.error('Error ensuring minimum posters:', error);
            });
          }
        }
        
        // Load initial posters
        fetchRandomPosters(15).then(data => {
          if (data.posters.length > 0) {
            addPostersToCarousel(data.posters, data.imdb_ids, data.lastfm_urls);
            
            // Start animation immediately
            setupInfiniteCarousel(carousel, async () => {
              // Load more random posters when needed
              const newData = await fetchRandomPosters(5);
              if (newData.posters.length > 0) {
                appendPostersToCarousel(newData.posters, newData.imdb_ids, newData.lastfm_urls);
              }
            });
          } else {
            // Fallback to original library_posters data if AJAX fails
            console.log('AJAX failed, using fallback data for', library);
            if (library === 'random-all') {
              // For random-all, combine all available posters
              const allPosters = [];
              const allImdbIds = [];
              Object.keys(libraryPosters).forEach(libName => {
                if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                  allPosters.push(...libraryPosters[libName]);
                  const imdbIds = posterImdbIds[libName] || [];
                  allImdbIds.push(...imdbIds);
                }
              });
              if (allPosters.length > 0) {
                // Get random selection from all posters
                const indices = [];
                for (let i = 0; i < Math.min(15, allPosters.length); i++) {
                  indices.push(Math.floor(Math.random() * allPosters.length));
                }
                const initialPosters = indices.map(i => allPosters[i]);
                const initialImdbIds = indices.map(i => allImdbIds[i] || null);
                
                addPostersToCarousel(initialPosters, initialImdbIds, []);
                
                // Start animation with fallback loading
                setupInfiniteCarousel(carousel, () => {
                  // Load more random posters
                  const nextIndices = [];
                  for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                    nextIndices.push(Math.floor(Math.random() * allPosters.length));
                  }
                  const nextBatch = nextIndices.map(i => allPosters[i]);
                  const nextImdbIds = nextIndices.map(i => allImdbIds[i] || null);
                  if (nextBatch.length > 0) {
                    appendPostersToCarousel(nextBatch, nextImdbIds, []);
                  }
                });
              } else {
                addPostersToCarousel([], [], []);
              }
            } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
              const posters = libraryPosters[library];
              const imdbIds = posterImdbIds[library] || [];
              
              // Use first 15 posters from the original data
              const initialPosters = posters.slice(0, 15);
              const initialImdbIds = imdbIds.slice(0, 15);
              
              addPostersToCarousel(initialPosters, initialImdbIds, []);
              
              // Start animation with fallback loading
              setupInfiniteCarousel(carousel, () => {
                // Load more from original data
                const currentCount = carousel.children.length;
                const nextBatch = posters.slice(currentCount, currentCount + 5);
                const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
                if (nextBatch.length > 0) {
                  appendPostersToCarousel(nextBatch, nextImdbIds, []);
                }
              });
            } else {
              // No posters available at all
              addPostersToCarousel([], [], []);
            }
          }
        }).catch(error => {
          console.error('Error in initial poster loading:', error);
          // Fallback to original library_posters data
          if (library === 'random-all') {
            // For random-all, combine all available posters
            const allPosters = [];
            const allImdbIds = [];
            Object.keys(libraryPosters).forEach(libName => {
              if (libraryPosters[libName] && libraryPosters[libName].length > 0) {
                allPosters.push(...libraryPosters[libName]);
                const imdbIds = posterImdbIds[libName] || [];
                allImdbIds.push(...imdbIds);
              }
            });
            if (allPosters.length > 0) {
              // Get random selection from all posters
              const indices = [];
              for (let i = 0; i < Math.min(15, allPosters.length); i++) {
                indices.push(Math.floor(Math.random() * allPosters.length));
              }
              const initialPosters = indices.map(i => allPosters[i]);
              const initialImdbIds = indices.map(i => allImdbIds[i] || null);
              
              addPostersToCarousel(initialPosters, initialImdbIds);
              
              setupInfiniteCarousel(carousel, () => {
                // Load more random posters
                const nextIndices = [];
                for (let i = 0; i < Math.min(5, allPosters.length); i++) {
                  nextIndices.push(Math.floor(Math.random() * allPosters.length));
                }
                const nextBatch = nextIndices.map(i => allPosters[i]);
                const nextImdbIds = nextIndices.map(i => allImdbIds[i] || null);
                if (nextBatch.length > 0) {
                  appendPostersToCarousel(nextBatch, nextImdbIds, []);
                }
              });
            } else {
              addPostersToCarousel([], [], []);
            }
          } else if (libraryPosters[library] && libraryPosters[library].length > 0) {
            const posters = libraryPosters[library];
            const imdbIds = posterImdbIds[library] || [];
            
            const initialPosters = posters.slice(0, 15);
            const initialImdbIds = imdbIds.slice(0, 15);
            
            addPostersToCarousel(initialPosters, initialImdbIds, []);
            
            setupInfiniteCarousel(carousel, () => {
              const currentCount = carousel.children.length;
              const nextBatch = posters.slice(currentCount, currentCount + 5);
              const nextImdbIds = imdbIds.slice(currentCount, currentCount + 5);
              if (nextBatch.length > 0) {
                appendPostersToCarousel(nextBatch, nextImdbIds, []);
              }
            });
          } else {
            addPostersToCarousel([], [], []);
          }
        });
      }
      
      // Library tab switching functionality
      const libraryTabs = document.querySelectorAll('.library-tab');
      
      libraryTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const targetLibrary = this.getAttribute('data-library');
          
          // Only reload if library actually changed
          if (currentLibrary !== targetLibrary) {
            console.log(`Switching from ${currentLibrary} to ${targetLibrary}`);
            
            // Update active tab
            libraryTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update current library tracking
            currentLibrary = targetLibrary;
            
            // Load new carousel data
            loadCarousel('main-carousel', targetLibrary);
          }
        });
      });

      // Only enable enlarge on screens wider than 1081px (adjust as needed)
      if (window.innerWidth >= 1081) {
        document.querySelectorAll(".toggle-grow").forEach(function (img) {
          img.addEventListener("click", function () {
            const isGrown = img.classList.toggle("grown");

            if (!isGrown) {
              img.style.left = "0px";
              img.style.top = "0px";
              img.style.position = "relative";
              img.style.zIndex = "";
            } else {
              img.style.position = "relative";
              img.style.zIndex = 10;
            }
          });
        });
      }

      // --- Improved Infinite Carousel Logic ---
      function setupInfiniteCarousel(carousel, onLoadMore = null) {
        const container = carousel.parentElement;
        let scrollSpeed = 0.5; // px per frame - increased for better visibility
        let isPaused = false;
        let offset = 0;
        let lastLoadCheck = 0;
        let isLoading = false; // Prevent multiple simultaneous loads

        // Clear any existing animation and event listeners
        if (carousel.rafId) {
          cancelAnimationFrame(carousel.rafId);
          carousel.rafId = null;
        }
        
        // Remove existing event listeners to prevent duplicates
        if (carousel._mouseEnterHandler) {
          container.removeEventListener('mouseenter', carousel._mouseEnterHandler);
        }
        if (carousel._mouseLeaveHandler) {
          container.removeEventListener('mouseleave', carousel._mouseLeaveHandler);
        }

        // Reset transform
        carousel.style.transform = 'translateX(0px)';

        // Set carousel width
        function updateWidth() {
          if (carousel.children.length === 0) {
            console.log('No children in carousel for width calculation');
            return;
          }
          
          let totalWidth = 0;
          const gap = parseInt(getComputedStyle(carousel).gap || 0);
          
          Array.from(carousel.children).forEach((img, index) => {
            const imgWidth = img.offsetWidth;
            if (imgWidth === 0) {
              console.log(`Image ${index} has zero width, using naturalWidth`);
              totalWidth += img.naturalWidth + gap;
            } else {
              totalWidth += imgWidth + gap;
            }
          });
          
          carousel.style.width = totalWidth + 'px';
          console.log(`Carousel width set to: ${totalWidth}px`);
        }
        
        // Update width immediately and after a short delay
        updateWidth();
        setTimeout(updateWidth, 100);

        // Animation loop using transform
        function animate() {
          try {
            // Don't animate if there are no images or if we have a loading/error message
            if (carousel.children.length === 0 || carousel.querySelector('div')) {
              carousel.rafId = requestAnimationFrame(animate);
              return;
            }
            
            if (!isPaused) {
              offset -= scrollSpeed;
              carousel.style.transform = `translateX(${offset}px)`;
              
              // Remove images that have scrolled completely off screen
              const firstImg = carousel.children[0];
              if (firstImg && (firstImg.tagName === 'IMG' || firstImg.tagName === 'A')) {
                const firstImgWidth = firstImg.offsetWidth + parseInt(getComputedStyle(carousel).gap || 0);
                if (Math.abs(offset) >= firstImgWidth) {
                  firstImg.remove();
                  offset += firstImgWidth;
                  carousel.style.transform = `translateX(${offset}px)`;
                  
                  // Update width after removing image
                  updateWidth();
                }
              }
              
              // Check if we need to load more posters (every 3 seconds)
              const now = Date.now();
              if (onLoadMore && now - lastLoadCheck > 3000 && !isLoading) {
                lastLoadCheck = now;
                const remainingImages = carousel.children.length;
                if (remainingImages <= 15) { // Load earlier to prevent gaps
                  console.log(`Only ${remainingImages} images left, loading more...`);
                  isLoading = true;
                  try {
                    onLoadMore().then(() => {
                      isLoading = false;
                    }).catch(error => {
                      console.error('Error loading more posters:', error);
                      isLoading = false;
                      // Use safety mechanism to ensure minimum posters
                      ensureMinimumPosters();
                    });
                  } catch (error) {
                    console.error('Error in onLoadMore:', error);
                    isLoading = false;
                    ensureMinimumPosters();
                  }
                }
              }
            }
            carousel.rafId = requestAnimationFrame(animate);
          } catch (error) {
            console.error('Animation error:', error);
            // Stop animation on error
            if (carousel.rafId) {
              cancelAnimationFrame(carousel.rafId);
              carousel.rafId = null;
            }
          }
        }
        
        // Start animation immediately
        console.log(`Starting animation for carousel ${carousel.id}`);
        animate();

        // Pause on hover - store handlers to prevent duplicates
        carousel._mouseEnterHandler = () => { 
          isPaused = true; 
          console.log('Carousel paused on hover');
        };
        carousel._mouseLeaveHandler = () => { 
          isPaused = false; 
          console.log('Carousel resumed on mouse leave');
        };
        container.addEventListener('mouseenter', carousel._mouseEnterHandler);
        container.addEventListener('mouseleave', carousel._mouseLeaveHandler);
        
        // Periodic safety check to ensure carousel doesn't become empty
        setInterval(() => {
          if (carousel.children.length < 5) {
            console.log('Carousel running low on posters, adding more...');
            ensureMinimumPosters();
          }
        }, 5000); // Check every 5 seconds
      }
    });
  </script>

</body>
</html>
