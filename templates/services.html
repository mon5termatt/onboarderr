<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ SERVER_NAME }}</title>
      <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp', v=favicon_timestamp) }}">
  <link rel="stylesheet" href="/static/style.css">
  <script>
    // Set accent color from environment variable
    document.addEventListener('DOMContentLoaded', function() {
      const accentColor = '{{ ACCENT_COLOR or "#d33fbc" }}';
      document.documentElement.style.setProperty('--accent-color', accentColor);
    });
  </script>
</head>
<body>
  {% include "_bottom_nav.html" %}
  <div class="container">
    <h1>Dashboard</h1>
    {% if custom_services_url %}
      <div class="custom-services-url" style="margin-bottom:2em;">
        <a href="{{ custom_services_url }}" target="_blank" style="font-size:1.2em; color:var(--accent);">Open Custom Services Page</a>
        <!-- Optionally, embed the page below -->
        <iframe src="{{ custom_services_url }}" style="width:100%;height:600px;border:1px solid #444;margin-top:1em;"></iframe>
      </div>
    {% elif show_services %}
      <div class="services">
        {% for service in services %}
          <a href="{{ service.url }}" class="service-box" target="_blank">
            <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 32px; height: 32px; border-radius: 8px;">
            <span>{{ service.name }}</span>
          </a>
        {% endfor %}
      </div>
    {% endif %}

    <h2 style="margin-top:3em;">Plex Requests</h2>
    {% if submissions %}
      <table style="width:100%; border-collapse: collapse; margin-top: 1em;">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Email</th>
            <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Libraries</th>
            <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for submission in submissions %}
            <tr data-plex-index="{{ loop.index0 }}">
              <td style="padding:0.5em;">{{ submission.email }}</td>
              <td style="padding:0.5em;">{{ submission.libraries_titles | join(', ') }}</td>
              <td style="padding:0.5em;">
                <button type="button" onclick="deletePlexRequest({{ loop.index0 }})" style="padding:0.3em 0.8em; font-size:0.9em; margin-top:1em;">Delete</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="margin-top:1em;">No Plex requests found.</p>
    {% endif %}

    <!-- Plex User Invitation Section -->
    {% if submissions %}
    <div style="margin-top: 2em; padding: 1.5em; background: #2a2a2a; border-radius: 0.5em;">
      <h3 style="margin-top: 0; margin-bottom: 1em; color: var(--accent);">Invite Plex Users</h3>
      <div style="color: #888; font-size: 0.95em; margin-bottom: 1.5em;">
        Select submissions to invite users to your Plex server. Users will be invited with access to the selected libraries.
      </div>
      <form id="plex-user-invite-form">
        <div style="margin-bottom: 1.5em;">
          <label style="display: block; margin-bottom: 0.5em; font-weight: bold;">Select submissions to invite:</label>
          <div style="margin-bottom: 1em;">
            <label style="display: flex; align-items: center; font-weight: 500; color: var(--accent);">
              <input type="checkbox" id="select_all_plex_users" style="margin-right: 0.5em;">
              Select All
            </label>
          </div>
          {% for submission in submissions %}
            <div style="margin-bottom: 0.8em; padding: 0.8em; background: #333; border-radius: 0.3em;">
              <input type="checkbox" name="invite_users" value="{{ loop.index0 }}" id="invite_user_{{ loop.index0 }}" class="plex-user-checkbox" style="margin-right: 0.5em;">
              <label for="invite_user_{{ loop.index0 }}" style="font-weight: 500;">
                <strong>{{ submission.email }}</strong>
              </label>
              <div style="margin-left: 1.5em; margin-top: 0.3em; color: #aaa; font-size: 0.9em;">
                Libraries: {{ submission.libraries_titles | join(', ') }} | Submitted: {{ submission.submitted_at[:10] }}
              </div>
            </div>
          {% endfor %}
        </div>
        <button type="button" onclick="invitePlexUsers()" style="padding: 0.6em 1.2em; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold;">
          Invite Selected Users to Plex
        </button>
      </form>
      <script>
        // Select All functionality for Plex user invitation
        document.addEventListener('DOMContentLoaded', function() {
          const selectAllCheckbox = document.getElementById('select_all_plex_users');
          const userCheckboxes = document.querySelectorAll('.plex-user-checkbox');
          if (selectAllCheckbox && userCheckboxes.length > 0) {
            selectAllCheckbox.addEventListener('change', function() {
              userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
              });
            });
            userCheckboxes.forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                const allChecked = Array.from(userCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(userCheckboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
              });
            });
          }
        });
      </script>
      {% if plex_invite_results %}
      <div style="margin-top: 2em;">
        <h4 style="margin-bottom: 1em; color: var(--accent);">Invitation Results:</h4>
        {% for result in plex_invite_results %}
          <div style="margin-bottom: 1em; padding: 0.8em; background: {% if result.success %}#1a3a1a{% else %}#3a1a1a{% endif %}; border-radius: 0.3em; border-left: 4px solid {% if result.success %}#4CAF50{% else %}#f44336{% endif %};">
            <div style="font-weight: bold; margin-bottom: 0.3em;">
              {{ result.email }}
            </div>
            <div style="color: {% if result.success %}#4CAF50{% else %}#f44336{% endif %}; font-weight: 500;">
              {% if result.success %}
                ✅ {{ result.message or 'Successfully invited user' }}
              {% else %}
                ❌ Failed to invite user: {{ result.error }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if ABS_ENABLED == 'yes' %}
    <h2 style="margin-top:3em;">Audiobookshelf Requests</h2>
      {% if audiobookshelf_submissions %}
        <div class="scrollable-table-container">
        <table style="width:100%; border-collapse: collapse; margin-top: 1em;">
          <thead>
            <tr>
              <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Email</th>
              <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Username</th>
              <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Password</th>
              <th style="text-align:left; padding:0.5em; border-bottom:1px solid #444;">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for submission in audiobookshelf_submissions %}
              <tr data-abs-index="{{ loop.index0 }}">
                <td style="padding:0.5em;">{{ submission.email }}</td>
                <td style="padding:0.5em;">{{ submission.username }}</td>
                <td style="padding:0.5em;">{{ submission.password }}</td>
                <td style="padding:0.5em;">
                  <button type="button" onclick="deleteAbsRequest({{ loop.index0 }})" style="padding:0.3em 0.8em; font-size:0.9em; margin-top:1em;">Delete</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
        
        <!-- ABS User Creation Section -->
        <div style="margin-top: 2em; padding: 1.5em; background: #2a2a2a; border-radius: 0.5em;">
          <h3 style="margin-top: 0; margin-bottom: 1em; color: var(--accent);">Create Audiobookshelf Users</h3>
          <div style="color: #888; font-size: 0.95em; margin-bottom: 1.5em;">
            Select submissions to create users in Audiobookshelf. Users will be created with the specified username and password.
          </div>
          
          <form id="abs-user-creation-form">
            <div style="margin-bottom: 1.5em;">
              <label style="display: block; margin-bottom: 0.5em; font-weight: bold;">Select submissions to create users:</label>
              <div style="margin-bottom: 1em;">
                <label style="display: flex; align-items: center; font-weight: 500; color: var(--accent);">
                  <input type="checkbox" id="select_all_users" style="margin-right: 0.5em;">
                  Select All
                </label>
              </div>
              {% for submission in audiobookshelf_submissions %}
                <div style="margin-bottom: 0.8em; padding: 0.8em; background: #333; border-radius: 0.3em;">
                  <input type="checkbox" name="create_users" value="{{ loop.index0 }}" id="create_user_{{ loop.index0 }}" class="user-checkbox" style="margin-right: 0.5em;">
                  <label for="create_user_{{ loop.index0 }}" style="font-weight: 500;">
                    <strong>{{ submission.username }}</strong> ({{ submission.email }})
                  </label>
                  <div style="margin-left: 1.5em; margin-top: 0.3em; color: #aaa; font-size: 0.9em;">
                    Password: {{ submission.password }} | Submitted: {{ submission.submitted_at[:10] }}
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <div style="margin-bottom: 1.5em;">
              <label style="display: block; margin-bottom: 0.5em; font-weight: bold;">User Type:</label>
              <select name="user_type" id="abs_user_type" style="padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; width: 200px;">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="guest">Guest</option>
              </select>
              <div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">
                <strong>User:</strong> Standard user access | <strong>Admin:</strong> Full administrative access | <strong>Guest:</strong> Limited access
              </div>
            </div>
            
            <div style="margin-bottom: 1.5em;">
              <label style="display: block; margin-bottom: 0.5em; font-weight: bold;">Permissions:</label>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8em;">
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="download" checked style="margin-right: 0.5em;">
                  Download items
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="update" style="margin-right: 0.5em;">
                  Update library items
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="delete" style="margin-right: 0.5em;">
                  Delete library items
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="upload" style="margin-right: 0.5em;">
                  Upload items
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="accessAllLibraries" checked style="margin-right: 0.5em;">
                  Access all libraries
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="accessAllTags" checked style="margin-right: 0.5em;">
                  Access all tags
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" name="permissions" value="accessExplicitContent" checked style="margin-right: 0.5em;">
                  Access explicit content
                </label>
              </div>
            </div>
            
            <button type="button" onclick="createAbsUsers()" style="padding: 0.6em 1.2em; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold;">
              Create Selected Users in Audiobookshelf
            </button>
          </form>
          
          <script>
            // Select All functionality for ABS user creation
            document.addEventListener('DOMContentLoaded', function() {
              const selectAllCheckbox = document.getElementById('select_all_users');
              const userCheckboxes = document.querySelectorAll('.user-checkbox');
              
              if (selectAllCheckbox && userCheckboxes.length > 0) {
                selectAllCheckbox.addEventListener('change', function() {
                  userCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                  });
                });
                
                // Update "Select All" state when individual checkboxes change
                userCheckboxes.forEach(checkbox => {
                  checkbox.addEventListener('change', function() {
                    const allChecked = Array.from(userCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(userCheckboxes).some(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                  });
                });
              }
            });
          </script>
          
          {% if abs_user_creation_results %}
          <div style="margin-top: 2em;">
            <h4 style="margin-bottom: 1em; color: var(--accent);">Creation Results:</h4>
            {% for result in abs_user_creation_results %}
              <div style="margin-bottom: 1em; padding: 0.8em; background: {% if result.success %}#1a3a1a{% else %}#3a1a1a{% endif %}; border-radius: 0.3em; border-left: 4px solid {% if result.success %}#4CAF50{% else %}#f44336{% endif %};">
                <div style="font-weight: bold; margin-bottom: 0.3em;">
                  {{ result.username }} ({{ result.email }})
                </div>
                <div style="color: {% if result.success %}#4CAF50{% else %}#f44336{% endif %}; font-weight: 500;">
                  {% if result.success %}
                    ✅ Successfully created user
                  {% else %}
                    ❌ Failed to create user: {{ result.error }}
                  {% endif %}
                </div>
                {% if result.success and result.user_id %}
                  <div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">
                    User ID: {{ result.user_id }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      {% else %}
        <p style="margin-top:1em;">No Audiobookshelf requests found.</p>
      {% endif %}
    {% endif %}

    <h2 style="margin-top:3em;">Storage</h2>
    <div style="margin-top:1em;">
      {% for drive in storage_info %}
        <div style="margin-bottom:1em;">
          <strong>{{ drive.mount }}</strong>: {{ drive.used }} GB used / {{ drive.total }} GB total ({{ drive.percent }}%)
          <div style="background:#333; height:10px; width:100%; border-radius:3px; margin-top:4px;">
            <div style="height:100%; width:{{ drive.percent }}%; background:var(--accent); border-radius:3px;"></div>
          </div>
        </div>
      {% endfor %}
    </div>

    <h2 style="margin-top:3em;">Settings</h2>
    <div style="margin-bottom:2em;">
      <form method="post" id="admin-settings-form" style="max-width: 600px;" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div style="margin-bottom: 1.2em; color: #aaa; font-size: 0.98em; display: flex; align-items: center;">
          <span style="margin-right: 0.5em;">🔑</span>
          <span style="font-weight: bold; margin-right: 0.3em;">SITE_PASSWORD</span> and <span style="font-weight: bold; margin-left: 0.3em;">ADMIN_PASSWORD&nbsp;</span> must be different.
        </div>
        <div class="muted" style="margin-bottom: 1.2em; font-size: 0.98em; margin-left: 2.1em;">
          Leaving either field blank will keep the current password.
        </div>
        <label style="display:block; margin-bottom: 1.2em;">SITE_PASSWORD (for guests):<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <span style="font-size: 1.2em; margin-right: 0.7em;">🔑</span>
            <input type="text" name="site_password" id="admin_site_password_box" value="{{ SITE_PASSWORD or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
          </div>
        </label>
        <label style="display:block; margin-bottom: 1.2em;">ADMIN_PASSWORD (for admin):<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <span style="font-size: 1.2em; margin-right: 0.7em;">🔑</span>
            <input type="text" name="admin_password" id="admin_admin_password_box" value="{{ ADMIN_PASSWORD or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
          </div>
        </label>
        <div id="admin-passwords-error" style="color:#f6b900; font-weight:bold; margin-bottom:1em;"></div>
        <label style="display:block; margin-bottom: 1.2em;">Server Name:<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <img src="{{ url_for('static', filename=logo_filename) }}" alt="Server Name" style="width: 24px; height: 24px; margin-right: 0.7em;">
            <input type="text" name="server_name" id="server_name" value="{{ SERVER_NAME or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
          </div>
        </label>
        <label style="display:block; margin-bottom: 1.2em;">Accent Color:<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <input type="color" name="accent_color" id="accent_color" value="{{ ACCENT_COLOR or '#d33fbc' }}" style="width: 60px; height: 40px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            <input type="text" name="accent_color_text" id="accent_color_text" value="{{ ACCENT_COLOR or '#d33fbc' }}" placeholder="#d33fbc" style="width: 120px; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            <span style="color: #888; font-size: 0.9em; margin-left: 10px;">Choose your theme color</span>
          </div>
        </label>
        
        <div style="margin-bottom: 2em;">
          <strong style="margin-bottom: 0.5em; display:block;">Custom Branding:</strong>
          <div style="color: #888; font-size: 0.95em; margin-bottom: 1em;">
            Upload your own logo and wordmark to customize the appearance.
          </div>
          
          <label style="display:block; margin-bottom: 1.2em;">Select New Logo (.png or .webp, ~300x300):<br>
            <input type="file" name="logo_file" id="logo_file_admin" accept=".png,.webp,.jpg,.jpeg" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            <div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">
              This will replace the logo and automatically create a favicon.
            </div>
          </label>
          
          <label style="display:block; margin-bottom: 1.2em;">Select New Wordmark (.png or .webp, minimum dimensions ~1000x250):<br>
            <input type="file" name="wordmark_file" id="wordmark_file_admin" accept=".png,.webp,.jpg,.jpeg" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            <div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">
              This will replace the wordmark image.
            </div>
          </label>
        </div>
        <label style="display:block; margin-bottom: 1.2em;">Plex Token:<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex Token" style="width: 24px; height: 24px; margin-right: 0.7em;">
            <input type="text" name="plex_token" id="plex_token" value="{{ PLEX_TOKEN or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
          </div>
        </label>
        <label style="display:block; margin-bottom: 1.2em;">Plex URL:<br>
          <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
            <img src="{{ url_for('static', filename='plex.webp') }}" alt="Plex URL" style="width: 24px; height: 24px; margin-right: 0.7em;">
            <input type="text" name="plex_url" id="plex_url" value="{{ PLEX_URL or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
          </div>
        </label>
        <button type="button" onclick="fetchLibrariesAdmin()" style="margin-bottom: 1.5em;">Fetch Plex Libraries</button><br>
        
        <!-- Current Library Selection Display -->
        {% if LIBRARY_IDS %}
        <div style="margin-bottom: 1.5em; padding: 1em; background: #2a2a2a; border-radius: 0.5em;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
            <strong style="display:block;">Currently Selected Libraries:</strong>
            <button type="button" onclick="refreshLibraryTitles()" style="padding: 0.3em 0.8em; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Refresh Titles</button>
          </div>
          {% set selected_ids = LIBRARY_IDS.split(',') %}
          {% for lib_id in selected_ids %}
            {% if lib_id.strip() %}
              <div style="margin-bottom: 0.5em;">
                <strong>
                  {% if library_notes[lib_id.strip()] and library_notes[lib_id.strip()]['title'] %}{{ library_notes[lib_id.strip()]['title'] }}{% else %}Unknown{% endif %} ({{ lib_id.strip() }})
                </strong>
                {% if library_notes[lib_id.strip()] and library_notes[lib_id.strip()]['description'] %}
                  <span style="color: #888; font-size: 0.9em;">— {{ library_notes[lib_id.strip()]['description'] }}</span>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
        
        <div id="libraries-section-admin" style="display:none; margin-bottom: 1.5em;">
          <strong style="margin-bottom: 0.5em; display:block;">Select Libraries to make available:</strong>
          <p>Title (ID)</p>
          <div id="libraries-list-admin"></div>
        </div>
        <div id="library-descriptions-section-admin" style="display:none; margin-bottom: 1.5em;">
          <strong style="margin-bottom: 0.5em; display:block;">Enter a description for each selected library (optional):</strong>
          <div id="library-descriptions-list-admin"></div>
        </div>

        <div id="abs-section-admin" style="margin-left: 20px; margin-bottom: 1.5em;">
          <label style="margin-bottom: 0.5em;">Audiobook Library ID:<br>
            <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobook Library ID" style="width: 24px; height: 24px; margin-right: 0.7em;">
              <input type="text" name="audiobooks_id" id="audiobooks_id" value="{{ AUDIOBOOKS_ID or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </label>
          <label style="margin-bottom: 0.5em;">Audiobookshelf Server URL:<br>
            <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf Server URL" style="width: 24px; height: 24px; margin-right: 0.7em;">
              <input type="text" name="audiobookshelf_url" id="audiobookshelf_url_admin" value="{{ AUDIOBOOKSHELF_URL or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </label>
          <label style="margin-bottom: 0.5em;">Audiobookshelf API Token:<br>
            <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
              <img src="{{ url_for('static', filename='abs.webp') }}" alt="Audiobookshelf API Token" style="width: 24px; height: 24px; margin-right: 0.7em;">
              <input type="text" name="audiobookshelf_token" id="audiobookshelf_token_admin" value="{{ AUDIOBOOKSHELF_TOKEN or '' }}" style="width: 100%; margin-top: 0.3em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </label>
          <div style="color: #888; font-size: 0.95em; margin-top: 0.5em;">Leave all fields empty to disable Audiobookshelf integration. All fields are required.</div>
        </div>

        <!-- Editable Service URLs -->
        <div style="margin-bottom: 2em;">
          <strong style="margin-bottom: 0.5em; display:block;">PUBLIC Service URLs:</strong>
          {% for service in all_services %}
            <div style="display: flex; align-items: center; margin-bottom: 1em;">
              <img src="{{ url_for('static', filename=service.logo) }}" alt="{{ service.name }} logo" style="width: 32px; height: 32px; border-radius: 8px; margin-right: 1em;">
              <label style="flex: 0 0 120px; font-weight: bold;">{{ service.name }}:</label>
              <input type="text" name="{{ service.env }}" value="{{ service.url }}" style="flex: 1 1 auto; margin-left: 1em; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          {% endfor %}
        </div>

        <div id="discord-section-admin" style="margin-left: 20px; margin-bottom: 1.5em;">
          <div style="margin-bottom: 1em;">
            <strong style="display:block; margin-bottom:0.5em;">Notification Events:</strong>
            <div style="display: flex; align-items: center; margin-bottom: 0.7em;">
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" style="width: 32px; height: 32px; border-radius: 8px; margin-right: 1em; object-fit: contain; background: #232323;" />
              <input type="checkbox" name="discord_notify_plex" id="discord_notify_plex" value="1" {% if DISCORD_NOTIFY_PLEX == '1' %}checked{% endif %} style="margin-right: 0.5em;">
              <label for="discord_notify_plex" style="font-weight: 500;">Notify on new Plex user request</label>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 0.7em;">
              <img src="{{ url_for('static', filename='discord.webp') }}" alt="Discord" style="width: 32px; height: 32px; border-radius: 8px; margin-right: 1em; object-fit: contain; background: #232323;" />
              <input type="checkbox" name="discord_notify_abs" id="discord_notify_abs" value="1" {% if DISCORD_NOTIFY_ABS == '1' %}checked{% endif %} style="margin-right: 0.5em;">
              <label for="discord_notify_abs" style="font-weight: 500;">Notify on new Audiobookshelf user request</label>
            </div>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 1em;">
            <label style="flex: 0 0 140px; font-weight: bold;">Webhook URL:</label>
            <div style="display: flex; align-items: center; margin-left: 1em;">
              <input type="text" name="discord_webhook" id="discord_webhook_admin" value="{{ DISCORD_WEBHOOK or '' }}" style="flex: 1 1 auto; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 1em;">
            <label style="flex: 0 0 140px; font-weight: bold;">Username (optional):</label>
            <div style="display: flex; align-items: center; margin-left: 1em;">
              <input type="text" name="discord_username" id="discord_username_admin" value="{{ DISCORD_USERNAME or '' }}" placeholder="Onboarderr" style="flex: 1 1 auto; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 1em;">
            <label style="flex: 0 0 140px; font-weight: bold;">Avatar URL (optional):</label>
            <div style="display: flex; align-items: center; margin-left: 1em;">
              <input type="text" name="discord_avatar" id="discord_avatar_admin" value="{{ DISCORD_AVATAR or '' }}" placeholder="Default Logo" style="flex: 1 1 auto; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 1em;">
            <label style="flex: 0 0 140px; font-weight: bold;">Color (optional):</label>
            <div style="display: flex; align-items: center; margin-left: 1em;">
              <input type="text" name="discord_color" id="discord_color_admin" value="{{ DISCORD_COLOR or '' }}" placeholder="#000000" style="flex: 1 1 auto; padding: 0.4em; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff;">
            </div>
          </div>
        </div>
        {% if error_message %}
        <div id="admin-setup-message" style="color: #f00; margin-bottom: 1em; padding: 0.7em 1em; background: #222; border-radius: 6px; border-left: 4px solid #f00;">{{ error_message }}</div>
        {% else %}
        <div id="admin-setup-message" style="color: #f00; margin-bottom: 1em;"></div>
        {% endif %}
        <button type="submit" id="admin-submit-btn" style="margin-top: 1.5em;">Apply Settings</button>
        <div style="margin-top:1.5em; color:#888; font-size:0.95em;">
          <b>Note:</b> Changes will only take effect after you restart the server.
        </div>
      </form>
      <script>
        // Initialize password validation
        function validateAdminPasswords() {
            var site = document.getElementById('admin_site_password_box').value.trim();
            var admin = document.getElementById('admin_admin_password_box').value.trim();
            var errorDiv = document.getElementById('admin-passwords-error');
            var submitBtn = document.getElementById('admin-submit-btn');
            let valid = true;
            if (!site && !admin) {
                errorDiv.textContent = '';
                valid = true;
            } else if (!site || !admin) {
                errorDiv.textContent = 'If changing, both SITE_PASSWORD and ADMIN_PASSWORD are required.';
                valid = false;
            } else if (site === admin) {
                errorDiv.textContent = 'SITE_PASSWORD and ADMIN_PASSWORD must be different.';
                valid = false;
            } else {
                errorDiv.textContent = '';
                valid = true;
            }
            if (submitBtn) submitBtn.disabled = !valid;
        }
        
        validateAdminPasswords();
        document.getElementById('admin_site_password_box').addEventListener('input', validateAdminPasswords);
        document.getElementById('admin_admin_password_box').addEventListener('input', validateAdminPasswords);
        
        // COLOR PICKER - THIS IS THE IMPORTANT PART
        const colorPicker = document.getElementById('accent_color');
        const colorText = document.getElementById('accent_color_text');
        
        if (colorPicker && colorText) {
            colorPicker.addEventListener('input', function() {
                colorText.value = this.value;
            });
            
            colorText.addEventListener('input', function() {
                if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                    colorPicker.value = this.value;
                }
            });
        }
        
        // Other functions...
        function fetchLibrariesAdmin() {
            var token = document.getElementById('plex_token').value;
            var url = document.getElementById('plex_url').value;
            if (!token || !url) {
                alert('Please enter Plex Token and URL first.');
                return;
            }
            var csrfToken = document.querySelector('input[name="csrf_token"]').value;
            fetch('/fetch-libraries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    plex_token: token,
                    plex_url: url
                })
            }).then(response => response.json()).then(data => {
                var section = document.getElementById('libraries-section-admin');
                var list = document.getElementById('libraries-list-admin');
                var descSection = document.getElementById('library-descriptions-section-admin');
                var descList = document.getElementById('library-descriptions-list-admin');
                list.innerHTML = '';
                descList.innerHTML = '';
                if (data.libraries && data.libraries.length > 0) {
                    section.style.display = 'block';
                    data.libraries.forEach(function(lib) {
                        var checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'library_ids';
                        checkbox.value = lib.key;
                        checkbox.id = 'admin_lib_' + lib.key;
                        var label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.innerText = lib.title + ' (' + lib.key + ')';
                        label.style.marginRight = '1em';
                        list.appendChild(checkbox);
                        list.appendChild(label);
                        list.appendChild(document.createElement('br'));
                        var descDiv = document.createElement('div');
                        descDiv.id = 'admindescdiv_' + lib.key;
                        descDiv.style.display = 'none';
                        descDiv.style.marginLeft = '2em';
                        descDiv.style.marginBottom = '1em';
                        var descLabel = document.createElement('label');
                        descLabel.innerText = 'Description for ' + lib.title + ':';
                        var descInput = document.createElement('input');
                        descInput.type = 'text';
                        descInput.name = 'library_desc_' + lib.key;
                        descInput.style.width = '60%';
                        descInput.style.marginTop = '0.3em';
                        descDiv.appendChild(descLabel);
                        descDiv.appendChild(document.createElement('br'));
                        descDiv.appendChild(descInput);
                        descList.appendChild(descDiv);
                        checkbox.addEventListener('change', function() {
                            descDiv.style.display = checkbox.checked ? 'block' : 'none';
                        });
                    });
                    descSection.style.display = 'block';
                } else {
                    section.style.display = 'none';
                    descSection.style.display = 'none';
                    alert('No libraries found or error fetching libraries.');
                }
            }).catch((err) => {
                alert('Failed to fetch libraries.');
                console.error(err);
            });
        }
        
        function refreshLibraryTitles() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Refreshing...';
            button.disabled = true;
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            fetch('/refresh-library-titles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Failed to refresh library titles: ' + (data.error || 'Unknown error'));
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Failed to refresh library titles. Please check your Plex connection.');
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        </script>
        
        <!-- AJAX Functions for Services Page -->
        <script>
          // Delete Plex request
          async function deletePlexRequest(index) {
            if (!confirm('Are you sure you want to delete this Plex request?')) {
              return;
            }
            
            try {
              const response = await fetch('/ajax/delete-plex-request', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ delete_index: index })
              });
              
              const result = await response.json();
              if (result.success) {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-plex-index="${index}"]`);
                if (row) {
                  row.remove();
                }
                // If no more submissions, reload the page to show "No Plex requests found"
                const tbody = document.querySelector('table tbody');
                if (tbody && tbody.children.length === 0) {
                  window.location.reload();
                }
              } else {
                alert('Failed to delete request: ' + (result.error || 'Unknown error'));
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Failed to delete request. Please try again.');
            }
          }
          
          // Delete Audiobookshelf request
          async function deleteAbsRequest(index) {
            if (!confirm('Are you sure you want to delete this Audiobookshelf request?')) {
              return;
            }
            
            try {
              const response = await fetch('/ajax/delete-abs-request', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ delete_index: index })
              });
              
              const result = await response.json();
              if (result.success) {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-abs-index="${index}"]`);
                if (row) {
                  row.remove();
                }
                // If no more submissions, reload the page to show "No Audiobookshelf requests found"
                const tbody = document.querySelector('.scrollable-table-container table tbody');
                if (tbody && tbody.children.length === 0) {
                  window.location.reload();
                }
              } else {
                alert('Failed to delete request: ' + (result.error || 'Unknown error'));
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Failed to delete request. Please try again.');
            }
          }
          
          // Invite Plex users
          async function invitePlexUsers() {
            const selectedCheckboxes = document.querySelectorAll('.plex-user-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
              alert('Please select at least one user to invite.');
              return;
            }
            
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Inviting...';
            button.disabled = true;
            
            try {
              const response = await fetch('/ajax/invite-plex-users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ selected_indices: selectedIndices })
              });
              
              const result = await response.json();
              if (result.success) {
                // Show results
                showPlexInviteResults(result.results);
                // Reload page to update the list
                setTimeout(() => {
                  window.location.reload();
                }, 3000);
              } else {
                alert('Failed to invite users: ' + (result.error || 'Unknown error'));
                button.textContent = originalText;
                button.disabled = false;
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Failed to invite users. Please try again.');
              button.textContent = originalText;
              button.disabled = false;
            }
          }
          
          // Create Audiobookshelf users
          async function createAbsUsers() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
              alert('Please select at least one user to create.');
              return;
            }
            
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const userType = document.getElementById('abs_user_type').value;
            const selectedPermissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Creating...';
            button.disabled = true;
            
            try {
              const response = await fetch('/ajax/create-abs-users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ 
                  selected_indices: selectedIndices,
                  user_type: userType,
                  permissions: selectedPermissions
                })
              });
              
              const result = await response.json();
              if (result.success) {
                // Show results
                showAbsCreationResults(result.results);
                // Reload page to update the list
                setTimeout(() => {
                  window.location.reload();
                }, 3000);
              } else {
                alert('Failed to create users: ' + (result.error || 'Unknown error'));
                button.textContent = originalText;
                button.disabled = false;
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Failed to create users. Please try again.');
              button.textContent = originalText;
              button.disabled = false;
            }
          }
          
          // Show Plex invite results
          function showPlexInviteResults(results) {
            const form = document.getElementById('plex-user-invite-form');
            const resultsDiv = document.createElement('div');
            resultsDiv.style.marginTop = '2em';
            resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Invitation Results:</h4>';
            
            results.forEach(result => {
              const resultDiv = document.createElement('div');
              resultDiv.style.marginBottom = '1em';
              resultDiv.style.padding = '0.8em';
              resultDiv.style.borderRadius = '0.3em';
              resultDiv.style.borderLeft = '4px solid';
              
              if (result.success) {
                resultDiv.style.background = '#1a3a1a';
                resultDiv.style.borderLeftColor = '#4CAF50';
                resultDiv.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
                  <div style="color: #4CAF50; font-weight: 500;">✅ ${result.message || 'Successfully invited user'}</div>
                `;
              } else {
                resultDiv.style.background = '#3a1a1a';
                resultDiv.style.borderLeftColor = '#f44336';
                resultDiv.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 0.3em;">${result.email}</div>
                  <div style="color: #f44336; font-weight: 500;">❌ Failed to invite user: ${result.error}</div>
                `;
              }
              
              resultsDiv.appendChild(resultDiv);
            });
            
            form.appendChild(resultsDiv);
          }
          
          // Show ABS creation results
          function showAbsCreationResults(results) {
            const form = document.getElementById('abs-user-creation-form');
            const resultsDiv = document.createElement('div');
            resultsDiv.style.marginTop = '2em';
            resultsDiv.innerHTML = '<h4 style="margin-bottom: 1em; color: var(--accent);">Creation Results:</h4>';
            
            results.forEach(result => {
              const resultDiv = document.createElement('div');
              resultDiv.style.marginBottom = '1em';
              resultDiv.style.padding = '0.8em';
              resultDiv.style.borderRadius = '0.3em';
              resultDiv.style.borderLeft = '4px solid';
              
              if (result.success) {
                resultDiv.style.background = '#1a3a1a';
                resultDiv.style.borderLeftColor = '#4CAF50';
                let resultHtml = `
                  <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
                  <div style="color: #4CAF50; font-weight: 500;">✅ Successfully created user</div>
                `;
                if (result.user_id) {
                  resultHtml += `<div style="color: #888; font-size: 0.9em; margin-top: 0.3em;">User ID: ${result.user_id}</div>`;
                }
                resultDiv.innerHTML = resultHtml;
              } else {
                resultDiv.style.background = '#3a1a1a';
                resultDiv.style.borderLeftColor = '#f44336';
                resultDiv.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 0.3em;">${result.username} (${result.email})</div>
                  <div style="color: #f44336; font-weight: 500;">❌ Failed to create user: ${result.error}</div>
                `;
              }
              
              resultsDiv.appendChild(resultDiv);
            });
            
            form.appendChild(resultsDiv);
          }
        </script>
    </div>
  </div>

</body>
</html>
